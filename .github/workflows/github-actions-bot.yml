name: GitHubActionsBot
on:
  pull_request_target:
    types:
      - opened
  issue_comment:
    types:
      - created

env:
  COMMANDS_JSON: |
    {
      "publish-pr-on-npm": "Build package from this PR and publish it on NPM"
    }
jobs:
  dump-github:
    runs-on: ubuntu-latest
    steps:
      - run: echo $GITHUB
        env:
          GITHUB: ${{ toJSON(github) }}

  hello-message:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v5
        with:
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: 'Help message',
            });

  accept-cmd:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '@github-actions ')
    runs-on: ubuntu-latest
    outputs:
      cmd: ${{ steps.parse-cmd.outputs.cmd }}
      replyMessage: ${{ steps.parse-cmd.outputs.replyMessage }}
    steps:
      - uses: actions/github-script@v5
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              ...context.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes',
            });

      - id: parse-cmd
        uses: actions/github-script@v5
        with:
          script: |
            const commands = JSON.parse(process.env.COMMANDS_JSON);
            const cmd = context.payload.comment.body.replace('@github-actions', '').trim();
            if (cmd in commands) {
              core.setOutput('cmd', cmd);
            } else {
              core.setOutput(
                'replyMessage',
                `Unknown command "${cmd}", please check help message at the top of PR.`,
              );
            }

  cmd-publish-pr-on-npm:
    needs: [accept-cmd]
    if: needs.accept-cmd.outputs.cmd == 'publish-pr-on-npm'
    runs-on: ubuntu-latest
    outputs:
      replyMessage: ${{ steps.test.outputs.replyMessage }}
    steps:
      - id: test
        uses: actions/github-script@v5
        with:
          script: |
            core.setOutput('replyMessage', 'Lorem ipsum');

  respond-to-cmd:
    needs:
      - accept-cmd
      - cmd-publish-pr-on-npm
    if: needs.accept-cmd.result != 'skipped' && always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v5
        with:
          script: |
            const { issue, comment, sender } = context.payload;
            const needs = JSON.parse(process.env.NEEDS);

            let replyMessage;
            for (const { result, outputs } of Object.values(needs)) {
              replyMessage = replyMessage || outputs.replyMessage;
            }

            replyMessage = replyMessage ||
              `Something went wrong, please check logs here:\n${process.env.RUN_URL}`;

            const quoteRequest = comment.body
              .split('\n')
              .map((line) => '> ' + line)
              .join('\n');

            github.rest.issues.createComment({
              ...context.repo,
              issue_number: issue.number,
              body: quoteRequest + `\n\n@${sender.login} ` + replyMessage,
            });

            // `github.rest` doesn't have this method :( so use graphql instead
            github.graphql(`
              mutation ($subjectId: ID!) {
                minimizeComment(input: { subjectId: $subjectId, classifier: RESOLVED})
                  { __typename }
              }
            `, { subjectId: comment.node_id });
        env:
          RUN_URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}
          NEEDS: ${{ toJSON(needs) }}
